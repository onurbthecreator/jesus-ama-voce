<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONURB - Reda√ß√£o Paran√°</title>
    <link rel="icon" href="https://static.wikia.nocookie.net/bb9e0e0f-96b2-4245-9568-4a0eba75ced7/scale-to-width/755">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: 
                linear-gradient(135deg, rgba(0, 0, 0, 0.164) 0%, rgba(0, 0, 0, 0) 100%),
                url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3bmIwd2lreDI5NGVvaWd1eGVjejMxeGRpMWpncHN5aTdvdXB3ZjhwciZlcD12MV9naWZzX3NlYXJjaCZjdD1n/cLM83RvATUc1E0SbjA/giphy.gif');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
            padding: 20px;
            color: #ffffff;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: #2e2b2e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #ffffff;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            color: #0867e2;
            font-size: 1.1em;
        }

        .card {
            background: #2e2b2e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgb(49, 83, 231);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ffffff;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #006999;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #1d4ac5;
        }

        .input-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #000000 0%, #000000 100%);
            color: rgb(255, 255, 255);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(65, 15, 11, 0.452);
        }

        .btn-secondary {
            background: #09189c;
            color: #333;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #092c8d;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .redacao-item {
            background: #31353a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #2040a8;
            cursor: pointer;
            transition: all 0.3s;
        }

        .redacao-item:hover {
            background: #393c3f;
            transform: translateX(5px);
        }

        .redacao-item.selected {
            background: #ffffff;
            color: rgb(255, 255, 255);
        }

        .redacao-item h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .redacao-item p {
            margin: 5px 0;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 10px;
        }

        .status-aberto { background: #4CAF50; color: white; }
        .status-rascunho { background: #003f72; color: #333; }
        .status-correcao { background: #FF9800; color: white; }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #ffffff;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #0742b1;
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #000000 0%, #000000 100%);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .word-count {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            z-index: -1;
        }

        .step:last-child::after {
            display: none;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #153eaf;
            color: #666;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .step.active .step-number {
            background: #ffffff;
            color: white;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .api-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .api-config h4 {
            margin-bottom: 10px;
            color: #ffffff;
        }

        .token-section {
            background: #252325;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #118dd4;
        }

        .token-section h4 {
            color: #020202;
            margin-bottom: 10px;
        }

        small {
            color: #ffffff;
            display: block;
            margin-top: 5px;
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        #debugConsole {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }

        #debugConsole h3 {
            color: #00ff00;
            margin: 0;
        }

        .debug-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 11, 11, 0.3);
            z-index: 1000;
            font-weight: 600;
        }

        .debug-btn:hover {
            background: #ff0000;
        }

        kbd {
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Reda√ß√£o Paran√°</h1>
            <p>Louvado seja o Senhor Jesus pela Tecnologia</p>
        </div>

        <div id="alertBox" class="alert"></div>

        <!-- Console de Debug -->
        <div id="debugConsole" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3>üêõ Console de Debug</h3>
                <button onclick="document.getElementById('debugConsole').classList.add('hidden')" style="background: #dc3545; color: rgb(255, 0, 0); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Fechar</button>
            </div>
            <div id="debugOutput" style="font-size: 12px; line-height: 1.6;"></div>
        </div>

        <!-- Etapa 1: Autentica√ß√£o -->
        <div id="step1" class="card">
            <h2 style="margin-bottom: 20px;">Autentica√ß√£o</h2>
            
            <div class="token-section">
                <h4>üìã Como pegar os tokens:</h4>
                <ol style="margin-left: 20px; line-height: 1.8;">
                    <li>Abra <a href="https://redacao.pr.gov.br" target="_blank">redacao.pr.gov.br</a></li>
                    <li>Fa√ßa login normalmente com sua conta Google</li>
                    <li><strong>IMPORTANTE:</strong> Ap√≥s o login, copie o <strong>link completo</strong> da URL (barra de endere√ßo do navegador)</li>
                    <li>O link deve come√ßar com: <code>https://redacao.pr.gov.br/#state=...</code></li>
                    <li>Pressione <kbd>F12</kbd> para abrir o DevTools</li>
                    <li>V√° na aba <strong>Application</strong> (ou <strong>Aplicativo</strong>)</li>
                    <li>No menu lateral, clique em <strong>Local Storage</strong> ‚Üí <strong>https://redacao.pr.gov.br</strong></li>
                    <li>Procure a chave <code>token</code> e copie o <strong>valor completo</strong></li>
                    <li>O token come√ßa com <code>eyJ</code> e tem 3 partes separadas por pontos</li>
                </ol>
                <div style="background: #161516; padding: 10px; border-radius: 5px; margin-top: 10px;">
                    <strong>üí° Dica:</strong> O token expira ap√≥s algumas horas. Se der erro de autentica√ß√£o, pegue um novo token!
                </div>
            </div>

            <div class="input-group">
                <label>  Link completo da plataforma (opcional):</label>
                <textarea id="linkInput" placeholder="https://redacao.pr.gov.br/#state=8&access_token=ya29"></textarea>
                <small>Cole aqui o link completo da URL quando estiver logado na plataforma</small>
            </div>

            <div class="input-group">
                <label>Bearer Token (JWT) - Obrigat√≥rio:</label>
                <textarea id="bearerInput" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"></textarea>
                <small>Cole aqui o Bearer Token que voc√™ copiou do Local Storage</small>
            </div>

            <div class="api-config">
                <h4>ü§ñ Configura√ß√£o da IA (Opcional)</h4>
                <div class="input-group">
                    <label>Provedor de IA:</label>
                    <select id="aiProvider">
                        <option value="groq">Groq (Recomendado)</option>
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic Claude</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>API Key (deixe vazio para texto de exemplo):</label>
                    <input type="password" id="apiKey" placeholder="sk-">
                    <small>Groq gratuito: <a href="https://console.groq.com/" target="_blank">console.groq.com</a></small>
                </div>
            </div>

            <button class="btn btn-primary" onclick="authenticate()">
                Conectar e Buscar Reda√ß√µes
            </button>
        </div>

        <!-- Etapa 2: Sele√ß√£o de Reda√ß√£o -->
        <div id="step2" class="card hidden">
            <h2 style="margin-bottom: 20px;">üìã Escolha uma Reda√ß√£o</h2>
            <div id="redacoesList"></div>
        </div>

        <!-- Etapa 3: Gera√ß√£o e Edi√ß√£o -->
        <div id="step3" class="card hidden">
            <h2 style="margin-bottom: 20px;">üìù Reda√ß√£o Gerada</h2>
            
            <div id="loadingGeneration" class="loading hidden">
                <div class="spinner"></div>
                <p>Gerando reda√ß√£o com IA...</p>
            </div>

            <div id="textEditor" class="hidden">
                <div class="input-group">
                    <label>Texto da Reda√ß√£o:</label>
                    <textarea id="textoRedacao" style="min-height: 300px; font-family: Georgia, serif; line-height: 1.8;"></textarea>
                    <div class="word-count" id="wordCount">0 palavras</div>
                </div>

                <div class="input-group">
                    <label>T√≠tulo:</label>
                    <input type="text" id="tituloRedacao">
                </div>

                <button class="btn btn-primary" onclick="enviarRedacao()">
                    üì§ Enviar Reda√ß√£o
                </button>
                <button class="btn btn-secondary" onclick="voltarParaLista()">
                    ‚Üê Voltar
                </button>
            </div>
        </div>

        <!-- Etapa 4: Progresso de Envio -->
        <div id="step4" class="card hidden">
            <h2 style="margin-bottom: 20px;">Enviando Reda√ß√£o</h2>
            
            <div class="step-indicator">
                <div class="step" id="stepSave">
                    <div class="step-number">1</div>
                    <div>Salvando</div>
                </div>
                <div class="step" id="stepSpell">
                    <div class="step-number">2</div>
                    <div>Ortografia</div>
                </div>
                <div class="step" id="stepWait">
                    <div class="step-number">3</div>
                    <div>Aguardando</div>
                </div>
                <div class="step" id="stepSend">
                    <div class="step-number">4</div>
                    <div>Enviando</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
            </div>

            <div id="progressText" style="text-align: center; color: #666; margin-top: 15px;">
                Iniciando...
            </div>
        </div>
    </div>

    <button class="debug-btn" onclick="toggleDebug()">üêõ Debug</button>

    <script>
        let token = null;
        let studentId = null;
        let redacoes = [];
        let redacaoSelecionada = null;
        let detalhesRedacao = null;
        let apiKey = null;
        let aiProvider = 'groq';
        let googleAccessToken = null;

        const baseURL = 'https://redacao-api.pr.gov.br/api/v2';

        // Sistema de Debug
        function toggleDebug() {
            const debugConsole = document.getElementById('debugConsole');
            debugConsole.classList.toggle('hidden');
        }

        function debugLog(message, type = 'info') {
            const output = document.getElementById('debugOutput');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff5555' : type === 'success' ? '#50fa7b' : '#00ff00';
            output.innerHTML += `<div style="color: ${color};">[${time}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        // Override console.log para capturar no debug
        const originalLog = console.log;
        const originalError = console.error;
        console.log = function(...args) {
            originalLog.apply(console, args);
            debugLog(args.join(' '), 'info');
        };
        console.error = function(...args) {
            originalError.apply(console, args);
            debugLog('‚ùå ' + args.join(' '), 'error');
        };

        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type} show`;
            alertBox.textContent = message;
            setTimeout(() => alertBox.classList.remove('show'), 5000);
        }

        function decodeJWT(token) {
            try {
                const payload = token.split('.')[1];
                return JSON.parse(atob(payload));
            } catch (e) {
                throw new Error('Token JWT inv√°lido');
            }
        }

        async function authenticate() {
            const linkInput = document.getElementById('linkInput').value.trim();
            const bearerInput = document.getElementById('bearerInput').value.trim();
            apiKey = document.getElementById('apiKey').value.trim() || null;
            aiProvider = document.getElementById('aiProvider').value;
            
            console.log('üîê Iniciando autentica√ß√£o...');
            
            // Extrair access_token do link
            if (linkInput) {
                const accessTokenMatch = linkInput.match(/access_token=([^&]+)/);
                if (accessTokenMatch) {
                    googleAccessToken = accessTokenMatch[1];
                    console.log('‚úÖ Google Access Token extra√≠do do link');
                }
            }

            // Validar Bearer Token
            if (!bearerInput) {
                showAlert('Por favor, insira o Bearer Token!', 'error');
                console.error('‚ùå Bearer Token n√£o fornecido');
                return;
            }

            // Limpar "Bearer " se presente
            token = bearerInput.replace(/^Bearer\s+/i, '').trim();
            
            // Validar se √© JWT
            if (token.split('.').length !== 3) {
                showAlert('Bearer Token inv√°lido! Deve come√ßar com eyJ...', 'error');
                console.error('‚ùå Token n√£o √© um JWT v√°lido');
                return;
            }

            try {
                const payload = decodeJWT(token);
                studentId = payload.sid;
                
                console.log('‚úÖ Token decodificado com sucesso');
                console.log('   Student ID:', studentId);
                
                showAlert('‚úÖ Autenticado com sucesso! ID: ' + studentId, 'success');
                
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                
                await carregarRedacoes();
            } catch (error) {
                showAlert('Erro ao autenticar: ' + error.message, 'error');
                console.error('‚ùå Erro na autentica√ß√£o:', error);
            }
        }

        async function carregarRedacoes() {
            try {
                showAlert('üîç Buscando reda√ß√µes dispon√≠veis...', 'info');
                
                console.log('üîç Carregando reda√ß√µes...');
                console.log('   Student ID:', studentId);
                console.log('   Token (primeiros 20 chars):', token ? token.substring(0, 20) + '...' : 'NULO');
                
                const url = `${baseURL}/proposta/estudante/${studentId}`;
                console.log('   URL:', url);
                
                const headers = {
                    'authorization': `Bearer ${token}`,
                    'content-type': 'application/json',
                    'accept': 'application/json',
                    'origin': 'https://redacao.pr.gov.br',
                    'referer': 'https://redacao.pr.gov.br/',
                    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                };
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors'
                });

                console.log('   Status:', response.status);

                if (!response.ok) {
                    let errorText = '';
                    try {
                        errorText = await response.text();
                    } catch (e) {
                        errorText = 'N√£o foi poss√≠vel ler o erro';
                    }
                    console.error('   Erro da API:', errorText);
                    
                    if (response.status === 401) {
                        throw new Error('Token expirado ou inv√°lido. Fa√ßa login novamente na plataforma e pegue um novo token!');
                    }
                    throw new Error('Erro ao buscar reda√ß√µes (Status: ' + response.status + '): ' + errorText.substring(0, 100));
                }

                redacoes = await response.json();
                console.log('‚úÖ Reda√ß√µes carregadas:', redacoes.length);
                
                // Filtrar reda√ß√µes dispon√≠veis
                const hoje = new Date();
                const redacoesDisponiveis = redacoes.filter(r => {
                    const prazo = new Date(r.dtFim);
                    return [1, 2, 3].includes(r.statusRedacao) && prazo >= hoje;
                });

                console.log('   Dispon√≠veis:', redacoesDisponiveis.length);

                if (redacoesDisponiveis.length === 0) {
                    showAlert('‚ùå Nenhuma reda√ß√£o dispon√≠vel no momento', 'warning');
                    return;
                }

                showAlert(`‚úÖ ${redacoesDisponiveis.length} reda√ß√£o(√µes) encontrada(s)!`, 'success');
                renderizarRedacoes(redacoesDisponiveis);
            } catch (error) {
                showAlert('‚ùå Erro: ' + error.message, 'error');
                console.error('‚ùå Erro ao carregar reda√ß√µes:', error);
                
                // Volta para a tela de autentica√ß√£o se for erro 401
                if (error.message.includes('Token expirado')) {
                    setTimeout(() => {
                        document.getElementById('step2').classList.add('hidden');
                        document.getElementById('step1').classList.remove('hidden');
                    }, 3000);
                }
            }
        }

        function renderizarRedacoes(redacoesDisponiveis) {
            const container = document.getElementById('redacoesList');
            container.innerHTML = '';

            redacoesDisponiveis.forEach(redacao => {
                const prazo = new Date(redacao.dtFim);
                const diasRestantes = Math.ceil((prazo - new Date()) / (1000 * 60 * 60 * 24));
                
                let statusClass = 'status-aberto';
                let statusText = 'üîµ Em aberto';
                
                if (redacao.statusRedacao === 2) {
                    statusClass = 'status-rascunho';
                    statusText = 'üü° Rascunho';
                } else if (redacao.statusRedacao === 3) {
                    statusClass = 'status-correcao';
                    statusText = 'üü† Corre√ß√£o online';
                }

                const urgente = diasRestantes <= 3 ? ' ‚ö†Ô∏è URGENTE!' : '';

                const div = document.createElement('div');
                div.className = 'redacao-item';
                div.onclick = () => selecionarRedacao(redacao);
                div.innerHTML = `
                    <h3><span class="status-badge ${statusClass}">${statusText}</span>${redacao.descTema}${urgente}</h3>
                    <p>üìù Tipo: ${redacao.descGenero}</p>
                    <p>üìä Palavras: ${redacao.minPalavra} - ${redacao.maxPalavra}</p>
                    <p>üìÖ Prazo: ${prazo.toLocaleDateString('pt-BR')} (${diasRestantes} dias)</p>
                `;

                container.appendChild(div);
            });
        }
async function selecionarRedacao(redacao) {
            redacaoSelecionada = redacao;
            
            showAlert(`üìñ Carregando: ${redacao.descTema}...`, 'info');

            try {
                console.log('üîç Buscando detalhes da reda√ß√£o:');
                console.log('   ID Proposta:', redacao.idProposta);
                console.log('   Student ID:', studentId);
                console.log('   Token presente:', !!token);
                
                const url = `${baseURL}/proposta/${redacao.idProposta}/estudante/${studentId}`;
                console.log('   URL:', url);
                
                const headers = {
                    'authorization': `Bearer ${token}`,
                    'content-type': 'application/json',
                    'accept': 'application/json',
                    'origin': 'https://redacao.pr.gov.br',
                    'referer': 'https://redacao.pr.gov.br/',
                    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                };
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors'
                });

                console.log('   Status da resposta:', response.status);
                console.log('   Content-Type:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    let errorText = '';
                    try {
                        errorText = await response.text();
                    } catch (e) {
                        errorText = 'N√£o foi poss√≠vel ler o erro';
                    }
                    console.error('   Erro da API:', errorText);
                    
                    if (response.status === 401) {
                        throw new Error('Token expirado ou inv√°lido. Pegue um novo token e tente novamente.');
                    } else if (response.status === 404) {
                        throw new Error('Reda√ß√£o n√£o encontrada. Ela pode ter sido removida.');
                    } else if (response.status === 403) {
                        throw new Error('Voc√™ n√£o tem permiss√£o para acessar esta reda√ß√£o.');
                    } else {
                        throw new Error(`Erro ${response.status}: ${errorText.substring(0, 100)}`);
                    }
                }

                // Parse do JSON
                let dados;
                try {
                    const responseText = await response.text();
                    console.log('   Tamanho da resposta:', responseText.length, 'caracteres');
                    console.log('   Primeiros 100 chars:', responseText.substring(0, 100));
                    
                    // For√ßa parse manual
                    dados = JSON.parse(responseText);
                    
                    console.log('‚úÖ JSON parseado com sucesso');
                    console.log('   Tipo ap√≥s parse:', typeof dados);
                    console.log('   √â objeto?', typeof dados === 'object' && dados !== null && !Array.isArray(dados));
                } catch (parseError) {
                    console.error('‚ùå Erro ao fazer parse do JSON:', parseError);
                    throw new Error('Erro ao processar resposta da API');
                }

                // Se ainda for string, tenta parsear novamente (double-encoded JSON)
                if (typeof dados === 'string') {
                    console.log('‚ö†Ô∏è Dados ainda s√£o string, tentando parse duplo...');
                    try {
                        dados = JSON.parse(dados);
                        console.log('‚úÖ Parse duplo bem-sucedido');
                        console.log('   Tipo agora:', typeof dados);
                    } catch (e) {
                        console.error('‚ùå Parse duplo falhou:', e);
                    }
                }
                
                if (dados && typeof dados === 'object') {
                    console.log('   Keys do objeto:', Object.keys(dados));
                }

                // Validar estrutura
                if (!dados || typeof dados !== 'object' || Array.isArray(dados)) {
                    console.error('‚ùå Resposta n√£o √© um objeto v√°lido');
                    console.error('   Tipo:', typeof dados);
                    console.error('   √â array?', Array.isArray(dados));
                    throw new Error('Resposta da API inv√°lida');
                }

                if (!dados.proposta) {
                    console.error('‚ùå Propriedade "proposta" n√£o encontrada');
                    console.error('   Keys dispon√≠veis:', Object.keys(dados));
                    throw new Error('Dados da proposta n√£o encontrados');
                }

                if (!dados.redacao || !dados.redacao.uIdRedacao) {
                    console.error('‚ùå ID da reda√ß√£o n√£o encontrado');
                    console.error('   dados.redacao:', dados.redacao);
                    throw new Error('ID da reda√ß√£o n√£o encontrado');
                }

                console.log('‚úÖ Valida√ß√£o completa OK:');
                console.log('   uIdRedacao:', dados.redacao.uIdRedacao);
                console.log('   Tema:', dados.proposta.descTema);
                console.log('   Palavras:', dados.proposta.minPalvra, '-', dados.proposta.maxPalavra);

                // Atualiza a vari√°vel global
                detalhesRedacao = dados;

                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                document.getElementById('loadingGeneration').classList.remove('hidden');

                await gerarTextoIA();
            } catch (error) {
                showAlert('‚ùå Erro ao carregar detalhes: ' + error.message, 'error');
                console.error('‚ùå Erro completo:', error);
                
                // N√£o esconde a lista de reda√ß√µes em caso de erro
                document.getElementById('step2').classList.remove('hidden');
                document.getElementById('step3').classList.add('hidden');
            }
        }

        async function gerarTextoIA() {
            console.log('ü§ñ Iniciando gera√ß√£o de texto...');
            console.log('   detalhesRedacao existe?', !!detalhesRedacao);
            console.log('   detalhesRedacao.proposta existe?', !!detalhesRedacao?.proposta);
            
            const detalhes = detalhesRedacao;
            
            if (!detalhes || !detalhes.proposta) {
                showAlert('‚ùå Erro: Detalhes da reda√ß√£o n√£o carregados corretamente', 'error');
                console.error('‚ùå Detalhes da reda√ß√£o n√£o dispon√≠veis');
                console.error('   detalhesRedacao:', detalhesRedacao);
                document.getElementById('loadingGeneration').classList.add('hidden');
                voltarParaLista();
                return;
            }
            
            console.log('‚úÖ Detalhes validados, gerando texto...');
            
            const limparHTML = (texto) => {
                if (!texto) return '';
                return texto.replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, ' ').trim();
            };
            
            const comando = limparHTML(detalhes.proposta.proposta);
            const textosApoio = detalhes.proposta.textoMotivacional && detalhes.proposta.textoMotivacional.length > 0
                ? detalhes.proposta.textoMotivacional.map(t => limparHTML(t.texto)).join('\n\n')
                : '';

            const prompt = `Escreva uma reda√ß√£o sobre o tema: "${detalhes.proposta.descTema}"

Tipo: ${detalhes.proposta.descGenero}
M√≠nimo de palavras: ${detalhes.proposta.minPalvra}
M√°ximo de palavras: ${detalhes.proposta.maxPalavra}

Instru√ß√µes: ${comando}

${textosApoio ? `Textos de apoio:\n${textosApoio}` : ''}

IMPORTANTE: 
- A reda√ß√£o deve ter entre ${detalhes.proposta.minPalvra} e ${detalhes.proposta.maxPalavra} palavras
- Use linguagem formal e apropriada
- Escreva APENAS o texto da reda√ß√£o, sem t√≠tulo
- Se for dissertativo-argumentativo, inclua introdu√ß√£o, desenvolvimento com argumentos e conclus√£o com proposta de interven√ß√£o`;

            let textoGerado = '';

            // Tenta gerar com IA se tiver API key
            if (apiKey) {
                try {
                    if (aiProvider === 'groq') {
                        console.log('   Usando Groq API...');
                        showAlert('ü§ñ Gerando com Groq...', 'info');
                        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                model: 'llama-3.3-70b-versatile',  // Modelo atualizado
                                messages: [
                                    {
                                        role: 'system',
                                        content: 'Voc√™ √© um especialista em reda√ß√£o brasileira, focado em textos dissertativo-argumentativos no estilo ENEM.'
                                    },
                                    {
                                        role: 'user',
                                        content: prompt
                                    }
                                ],
                                temperature: 0.7,
                                max_tokens: 2048
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || 'Erro na API do Groq');
                        }

                        const data = await response.json();
                        if (data.choices && data.choices[0]) {
                            textoGerado = data.choices[0].message.content.trim();
                            console.log('‚úÖ Texto gerado pelo Groq!');
                            showAlert('‚úÖ Texto gerado pelo Groq!', 'success');
                        } else {
                            throw new Error('Resposta inv√°lida da API');
                        }
                    } else if (aiProvider === 'openai') {
                        console.log('   Usando OpenAI API...');
                        showAlert('ü§ñ Gerando com OpenAI...', 'info');
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                model: 'gpt-3.5-turbo',
                                messages: [
                                    {
                                        role: 'system',
                                        content: 'Voc√™ √© um especialista em reda√ß√£o brasileira.'
                                    },
                                    {
                                        role: 'user',
                                        content: prompt
                                    }
                                ],
                                temperature: 0.7,
                                max_tokens: 2000
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || 'Erro na API do OpenAI');
                        }

                        const data = await response.json();
                        textoGerado = data.choices[0].message.content.trim();
                        console.log('‚úÖ Texto gerado pelo OpenAI!');
                        showAlert('‚úÖ Texto gerado pelo OpenAI!', 'success');
                    } else if (aiProvider === 'anthropic') {
                        console.log('   Usando Anthropic API...');
                        showAlert('ü§ñ Gerando com Claude...', 'info');
                        const response = await fetch('https://api.anthropic.com/v1/messages', {
                            method: 'POST',
                            headers: {
                                'x-api-key': apiKey,
                                'anthropic-version': '2023-06-01',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                model: 'claude-3-haiku-20240307',
                                max_tokens: 2000,
                                messages: [
                                    {
                                        role: 'user',
                                        content: prompt
                                    }
                                ]
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || 'Erro na API do Anthropic');
                        }

                        const data = await response.json();
                        textoGerado = data.content[0].text.trim();
                        console.log('‚úÖ Texto gerado pelo Claude!');
                        showAlert('‚úÖ Texto gerado pelo Claude!', 'success');
                    }
                } catch (error) {
                    console.error('‚ö†Ô∏è Erro na IA:', error);
                    showAlert('‚ö†Ô∏è Erro na IA: ' + error.message + '. Usando texto de exemplo.', 'warning');
                    textoGerado = gerarTextoExemplo();
                }
            } else {
                console.log('   Sem API key, gerando texto de exemplo');
                textoGerado = gerarTextoExemplo();
                showAlert('‚ö†Ô∏è Sem API key configurada. Usando texto de exemplo que voc√™ pode editar.', 'warning');
            }

            document.getElementById('loadingGeneration').classList.add('hidden');
            document.getElementById('textEditor').classList.remove('hidden');
            
            document.getElementById('textoRedacao').value = textoGerado;
            document.getElementById('tituloRedacao').value = `Reda√ß√£o - ${redacaoSelecionada.descTema.substring(0, 40)}`;
            
            atualizarContadorPalavras();
            
            document.getElementById('textoRedacao').addEventListener('input', atualizarContadorPalavras);
        }

        function gerarTextoExemplo() {
            let tema = 'os desafios contempor√¢neos';
            
            // Tenta pegar o tema de diferentes formas
            if (detalhesRedacao && detalhesRedacao.proposta && detalhesRedacao.proposta.descTema) {
                tema = detalhesRedacao.proposta.descTema;
            } else if (redacaoSelecionada && redacaoSelecionada.descTema) {
                tema = redacaoSelecionada.descTema;
            }
            
            return `    A sociedade contempor√¢nea enfrenta diversos desafios relacionados a ${tema}. √â fundamental compreender que este tema possui m√∫ltiplas dimens√µes que impactam diretamente a vida dos cidad√£os brasileiros. A an√°lise criteriosa deste assunto revela aspectos sociais, culturais e econ√¥micos que merecem aten√ß√£o especial.

    No cen√°rio brasileiro, observa-se que diferentes fatores contribuem para a complexidade desta quest√£o. A educa√ß√£o, a participa√ß√£o social e as pol√≠ticas p√∫blicas desempenham pap√©is essenciais na constru√ß√£o de solu√ß√µes efetivas. Al√©m disso, a conscientiza√ß√£o da popula√ß√£o √© imprescind√≠vel para o desenvolvimento de uma sociedade mais justa e igualit√°ria.

    Diante deste panorama, torna-se evidente a necessidade de a√ß√µes concretas e coordenadas. √â preciso que o poder p√∫blico, em parceria com a sociedade civil e as institui√ß√µes educacionais, desenvolva estrat√©gias integradas. Somente atrav√©s do di√°logo, da participa√ß√£o democr√°tica e do compromisso coletivo ser√° poss√≠vel superar os obst√°culos e promover mudan√ßas significativas.

    Portanto, conclui-se que a supera√ß√£o destes desafios requer um esfor√ßo conjunto de toda a sociedade. A implementa√ß√£o de pol√≠ticas p√∫blicas eficazes, aliada √† conscientiza√ß√£o e participa√ß√£o cidad√£, constitui o caminho para a constru√ß√£o de um futuro mais promissor e equitativo para todos os brasileiros.`;
        }

        function atualizarContadorPalavras() {
            const texto = document.getElementById('textoRedacao').value;
            const palavras = texto.trim().split(/\s+/).filter(p => p.length > 0).length;
            const counter = document.getElementById('wordCount');
            
            counter.textContent = `${palavras} palavras`;
            
            const min = detalhesRedacao.proposta.minPalvra;
            const max = detalhesRedacao.proposta.maxPalavra;
            
            if (palavras < min) {
                counter.style.color = '#dc3545';
                counter.textContent += ` (m√≠nimo: ${min})`;
            } else if (palavras > max) {
                counter.style.color = '#dc3545';
                counter.textContent += ` (m√°ximo: ${max})`;
            } else {
                counter.style.color = '#28a745';
                counter.textContent += ' ‚úÖ';
            }
        }

        function voltarParaLista() {
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        async function enviarRedacao() {
            const texto = document.getElementById('textoRedacao').value.trim();
            const titulo = document.getElementById('tituloRedacao').value.trim();

            if (!texto) {
                showAlert('‚ùå O texto da reda√ß√£o n√£o pode estar vazio!', 'error');
                console.error('‚ùå Tentativa de envio com texto vazio');
                return;
            }

            const palavras = texto.split(/\s+/).filter(p => p.length > 0).length;
            const min = detalhesRedacao.proposta.minPalvra;
            const max = detalhesRedacao.proposta.maxPalavra;

            console.log('üìä Verificando contagem de palavras:', palavras);

            if (palavras < min || palavras > max) {
                if (!confirm(`‚ö†Ô∏è A reda√ß√£o tem ${palavras} palavras (permitido: ${min}-${max}).\n\nDeseja continuar mesmo assim?`)) {
                    console.log('‚ùå Usu√°rio cancelou envio devido √† contagem de palavras');
                    return;
                }
            }

            if (!confirm(`üìã Confirmar envio?\n\nüìù Tema: ${redacaoSelecionada.descTema}\nüìä Palavras: ${palavras}\nüìå T√≠tulo: ${titulo}\n\n‚úÖ Enviar para corre√ß√£o?`)) {
                console.log('‚ùå Usu√°rio cancelou envio');
                return;
            }

            console.log('üöÄ Iniciando processo de envio...');

            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');

            try {
                await processarEnvio(texto, titulo);
            } catch (error) {
                showAlert('‚ùå Erro ao enviar: ' + error.message, 'error');
                console.error('‚ùå Erro no processo de envio:', error);
                document.getElementById('step4').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
            }
        }

        async function processarEnvio(texto, titulo) {
            const uIdRedacao = detalhesRedacao.redacao.uIdRedacao;
            const essayId = redacaoSelecionada.idProposta;

            console.log('üì§ Iniciando processo de envio...');
            console.log('   uIdRedacao:', uIdRedacao);
            console.log('   essayId:', essayId);
            console.log('   Palavras:', texto.split(/\s+/).length);

            try {
                // Etapa 1: Salvar rascunho
                updateProgress(10, 'üíæ Salvando rascunho...', 'stepSave');
                await salvarRascunho(uIdRedacao, essayId, texto, titulo);
                updateProgress(25, '‚úÖ Rascunho salvo!');
                console.log('‚úÖ ETAPA 1 COMPLETA');

                // Etapa 2: Corre√ß√£o ortogr√°fica
                updateProgress(30, 'üîç Verificando ortografia...', 'stepSpell');
                await corrigirOrtografia(uIdRedacao, essayId, texto, titulo);
                updateProgress(50, '‚úÖ Ortografia verificada!');
                console.log('‚úÖ ETAPA 2 COMPLETA');

                // Etapa 3: Aguardar 25 segundos
                updateProgress(50, '‚è≥ Aguardando processamento da plataforma...', 'stepWait');
                console.log('‚è≥ Iniciando aguardo de 25 segundos...');
                for (let i = 0; i < 25; i++) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    const progress = 50 + ((i + 1) / 25 * 25);
                    updateProgress(progress, `‚è≥ Aguardando processamento... ${25 - i}s`);
                }
                console.log('‚úÖ ETAPA 3 COMPLETA (aguardo finalizado)');

                // Etapa 4: Enviar para corre√ß√£o
                updateProgress(80, 'üì§ Enviando para corre√ß√£o do professor...', 'stepSend');
                await enviarParaCorrecao(uIdRedacao, essayId, texto, titulo);
                updateProgress(100, 'üéâ Reda√ß√£o enviada com sucesso!');
                console.log('‚úÖ ETAPA 4 COMPLETA');
                
                console.log('üéâ PROCESSO COMPLETO!');
                
                setTimeout(() => {
                    showAlert('‚úÖ Reda√ß√£o enviada e aguardando corre√ß√£o! Voc√™ pode fechar esta p√°gina.', 'success');
                }, 1000);
            } catch (error) {
                console.error('‚ùå ERRO NO PROCESSO DE ENVIO:', error);
                throw error;
            }
        }

        function updateProgress(percent, text, stepId = null) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
            progressText.textContent = text;

            if (stepId) {
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById(stepId).classList.add('active');
                
                // Marcar steps anteriores como completos
                const steps = ['stepSave', 'stepSpell', 'stepWait', 'stepSend'];
                const currentIndex = steps.indexOf(stepId);
                for (let i = 0; i < currentIndex; i++) {
                    document.getElementById(steps[i]).classList.add('completed');
                }
            }
        }

        async function salvarRascunho(uIdRedacao, essayId, texto, titulo) {
            console.log('üíæ Salvando rascunho...');
            console.log('   uIdRedacao:', uIdRedacao);
            console.log('   essayId:', essayId);
            console.log('   Tamanho do texto:', texto.length);
            
            try {
                const response = await fetch(`${baseURL}/redacao/salvar/${uIdRedacao}`, {
                    method: 'POST',
                    headers: {
                        'authorization': `Bearer ${token}`,
                        'content-type': 'application/json',
                        'accept': 'application/json',
                        'origin': 'https://redacao.pr.gov.br',
                        'referer': 'https://redacao.pr.gov.br/'
                    },
                    body: JSON.stringify({
                        essayId: essayId,
                        text: texto,
                        title: titulo,
                        status: 2
                    })
                });

                console.log('   Status da resposta:', response.status);

                if (!response.ok) {
                    const error = await response.text();
                    console.error('‚ùå Erro ao salvar rascunho:', error);
                    throw new Error('Erro ao salvar rascunho: ' + error);
                }

                // Tenta ler o JSON, mas aceita resposta vazia
                let result = null;
                try {
                    const responseText = await response.text();
                    console.log('   Resposta (texto):', responseText.substring(0, 200));
                    
                    if (responseText && responseText.trim().length > 0) {
                        result = JSON.parse(responseText);
                        console.log('‚úÖ Rascunho salvo com sucesso');
                        console.log('   Resposta:', result);
                    } else {
                        console.log('‚úÖ Rascunho salvo com sucesso (resposta vazia)');
                    }
                } catch (parseError) {
                    console.log('‚ö†Ô∏è Resposta n√£o √© JSON, mas salvou (status 200)');
                }
                
                return result;
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o de salvar:', error);
                throw error;
            }
        }

        async function corrigirOrtografia(uIdRedacao, essayId, texto, titulo) {
            console.log('üîç Verificando ortografia...');
            console.log('   uIdRedacao:', uIdRedacao);
            console.log('   essayId:', essayId);
            console.log('   studentId:', studentId);
            
            try {
                const response = await fetch(`${baseURL}/correcao/ortografia/${uIdRedacao}`, {
                    method: 'POST',
                    headers: {
                        'authorization': `Bearer ${token}`,
                        'content-type': 'application/json',
                        'accept': 'application/json',
                        'origin': 'https://redacao.pr.gov.br',
                        'referer': 'https://redacao.pr.gov.br/'
                    },
                    body: JSON.stringify({
                        essayId: essayId,
                        studentId: studentId,
                        text: texto,
                        title: titulo,
                        status: 3
                    })
                });

                console.log('   Status da resposta:', response.status);

                if (!response.ok) {
                    const error = await response.text();
                    console.error('‚ùå Erro ao verificar ortografia:', error);
                    throw new Error('Erro ao verificar ortografia: ' + error);
                }

                // Tenta ler o JSON
                let data = null;
                try {
                    const responseText = await response.text();
                    console.log('   Resposta (primeiros 200 chars):', responseText.substring(0, 200));
                    
                    if (responseText && responseText.trim().length > 0) {
                        data = JSON.parse(responseText);
                        console.log('   Resposta da API:', data);
                        
                        if (data.matches && data.matches.length > 0) {
                            console.log(`‚ö†Ô∏è Encontrados ${data.matches.length} poss√≠veis erros de ortografia`);
                        } else {
                            console.log('‚úÖ Nenhum erro de ortografia encontrado');
                        }
                    } else {
                        console.log('‚úÖ Ortografia verificada (resposta vazia)');
                    }
                } catch (parseError) {
                    console.log('‚ö†Ô∏è Resposta n√£o √© JSON, mas verificou (status 200)');
                }

                return data;
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o de ortografia:', error);
                throw error;
            }
        }

        async function enviarParaCorrecao(uIdRedacao, essayId, texto, titulo) {
            console.log('üì§ Enviando para corre√ß√£o...');
            console.log('   uIdRedacao:', uIdRedacao);
            console.log('   essayId:', essayId);
            
            try {
                const response = await fetch(`${baseURL}/redacao/enviar-para-correcao/${uIdRedacao}`, {
                    method: 'POST',
                    headers: {
                        'authorization': `Bearer ${token}`,
                        'content-type': 'application/json',
                        'accept': 'application/json',
                        'origin': 'https://redacao.pr.gov.br',
                        'referer': 'https://redacao.pr.gov.br/'
                    },
                    body: JSON.stringify({
                        essayId: essayId,
                        text: texto,
                        title: titulo,
                        status: 4
                    })
                });

                console.log('   Status da resposta:', response.status);

                if (!response.ok) {
                    const error = await response.text();
                    console.error('‚ùå Erro ao enviar para corre√ß√£o:', error);
                    throw new Error('Erro ao enviar para corre√ß√£o: ' + error);
                }

                // Tenta ler o JSON, mas aceita resposta vazia
                let result = null;
                const responseText = await response.text();
                console.log('   Resposta (texto):', responseText.substring(0, 200));
                
                if (responseText && responseText.trim().length > 0) {
                    try {
                        result = JSON.parse(responseText);
                        console.log('‚úÖ Enviado para corre√ß√£o com sucesso');
                        console.log('   Resposta:', result);
                    } catch (parseError) {
                        console.log('‚ö†Ô∏è Resposta n√£o √© JSON v√°lido, mas enviou (status 200)');
                    }
                } else {
                    console.log('‚úÖ Enviado para corre√ß√£o com sucesso (resposta vazia)');
                }
                
                return result;
            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o de envio:', error);
                throw error;
            }
        }

        // Log inicial
        console.log('üéì Automa√ß√£o Reda√ß√£o Paran√° carregada');
        console.log('   Vers√£o: 2.0 com Debug');
        console.log('   API Base URL:', baseURL);
    </script>
</body>
</html>
       